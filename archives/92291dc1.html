<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="反射" />





  <link rel="alternate" href="/atom.xml" title="YunLin Blog" type="application/atom+xml" />






<meta name="description" content="前言反射作为Java程序开发中的一把黄油刀，在很多功能场景下都占据着重要的位置，比如热加载、动态配置化等等。很多Android的开源项目也有用到反射机制，来减轻开发者的工作量，比如说EventBus。 在这篇文章中，我们将会从反射的定义、原理、用途、运用、实例五个方面来进行具体分析。 反射的定义Oracle官方对反射的解释是：  Reflection enables Java code to di">
<meta name="keywords" content="反射">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 反射机制">
<meta property="og:url" content="http://yunlin.live/archives/92291dc1.html">
<meta property="og:site_name" content="YunLin Blog">
<meta property="og:description" content="前言反射作为Java程序开发中的一把黄油刀，在很多功能场景下都占据着重要的位置，比如热加载、动态配置化等等。很多Android的开源项目也有用到反射机制，来减轻开发者的工作量，比如说EventBus。 在这篇文章中，我们将会从反射的定义、原理、用途、运用、实例五个方面来进行具体分析。 反射的定义Oracle官方对反射的解释是：  Reflection enables Java code to di">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yunlin.live/archives/92291dc1/Java内存模型.jpg">
<meta property="og:updated_time" content="2018-09-17T00:32:32.262Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 反射机制">
<meta name="twitter:description" content="前言反射作为Java程序开发中的一把黄油刀，在很多功能场景下都占据着重要的位置，比如热加载、动态配置化等等。很多Android的开源项目也有用到反射机制，来减轻开发者的工作量，比如说EventBus。 在这篇文章中，我们将会从反射的定义、原理、用途、运用、实例五个方面来进行具体分析。 反射的定义Oracle官方对反射的解释是：  Reflection enables Java code to di">
<meta name="twitter:image" content="http://yunlin.live/archives/92291dc1/Java内存模型.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yunlin.live/archives/92291dc1.html"/>





  <title>Java 反射机制 | YunLin Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YunLin Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yunlin.live/archives/92291dc1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YunLinYe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/icon.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YunLin Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java 反射机制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-17T08:29:25+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android插件化和热修复/" itemprop="url" rel="index">
                    <span itemprop="name">Android插件化和热修复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>反射作为Java程序开发中的一把黄油刀，在很多功能场景下都占据着重要的位置，比如热加载、动态配置化等等。很多Android的开源项目也有用到反射机制，来减轻开发者的工作量，比如说EventBus。</p>
<p>在这篇文章中，我们将会从反射的定义、原理、用途、运用、实例五个方面来进行具体分析。</p>
<h2 id="反射的定义"><a href="#反射的定义" class="headerlink" title="反射的定义"></a>反射的定义</h2><p>Oracle官方对反射的解释是：</p>
<blockquote>
<p>Reflection enables Java code to discover information about the fields, methods and constructors of loaded classes, and to use reflected fields, methods, and constructors to operate on their underlying counterparts, within security restrictions. The API accommodates applications that need access to either the public members of a target object (based on its runtime class) or the members declared by a given class. It also allows programs to suppress default reflective access control.</p>
</blockquote>
<p>简而言之，是指通过反射机制，在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性。</p>
<p>这种动态获取信息以及动态调用对象方法的功能称为Java语言的反射机制。而且，不仅仅是获取该类的属性和方法，而且我们可以动态的修改该类的成员变量，来替换成我们需要的值。</p>
<p>其常用的功能是：</p>
<ul>
<li>得到类的对象；</li>
<li>获取以及设置该类的字段、方法和属性（共有或私有）；</li>
</ul>
<h2 id="反射的原理"><a href="#反射的原理" class="headerlink" title="反射的原理"></a>反射的原理</h2><p>我们可以看下这张经典的Java内存模型：</p>
<p><img src="/archives/92291dc1/Java内存模型.jpg" alt="Java 内存模型"></p>
<p>在程序中，每个java文件最终都会被编译成一个.class文件，这些Class对象承载了这个类的所有信息，包括父类、接口、构造函数、方法、属性等，这些.class文件在程序运行时会被ClassLoader加载到虚拟机中。</p>
<p>当一个类被加载以后，Java虚拟机就会在内存中自动产生一个Class对象，而我们一般情况下用new来创建对象，有了class对象的引用，就相当于有了Method、Field、Constructor的相关信息，这样就能创建对象、获取对象信息等操作。</p>
<h2 id="反射的用途"><a href="#反射的用途" class="headerlink" title="反射的用途"></a>反射的用途</h2><p>反射在实际项目开发中用得较为广泛，比如调用类的私有方法、修改对象的成员变量等。</p>
<p>而在开源项目EventBus中，最终的事件分发即是用了反射机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        handleSubscriberException(subscription, event, e.getCause());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配合注解的使用，鸡肉味嘎嘣脆。</p>
<h2 id="反射的运用"><a href="#反射的运用" class="headerlink" title="反射的运用"></a>反射的运用</h2><h3 id="得到类的对象"><a href="#得到类的对象" class="headerlink" title="得到类的对象"></a>得到类的对象</h3><ol>
<li><p>getClass</p>
<p>通过对象，来获取该类。类型用Class表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String reflectContent = <span class="string">"Hello world!"</span>;</span><br><span class="line">Class cl = reflectContent.getClass();</span><br><span class="line">System.out.println(cl);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Class.fromName</p>
<p>通过字符串，来获取类型。类型用Class表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"java.lang.String"</span>);</span><br><span class="line">    System.out.println(clFromName);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="获取以及设置该类的字段、方法和属性"><a href="#获取以及设置该类的字段、方法和属性" class="headerlink" title="获取以及设置该类的字段、方法和属性"></a>获取以及设置该类的字段、方法和属性</h3><p>首先我们定义测试类，后面所有的实例将会以该测试类展开：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"yunlinos"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReflectModel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReflectModel</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>调用构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectModel</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"com.yunlinos.reflectutils.ReflectModel"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参数构造函数</span></span><br><span class="line">    Constructor constructor0 = clFromName.getDeclaredConstructor();</span><br><span class="line">    ReflectModel reflectModel0 = (ReflectModel) constructor0.newInstance();</span><br><span class="line">    reflectModel0.printName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有参数构造函数</span></span><br><span class="line">    Class[] parameters = &#123;String.class, <span class="keyword">int</span>.class&#125;;</span><br><span class="line">    Constructor constructor1 = clFromName.getDeclaredConstructor(parameters);</span><br><span class="line">    ReflectModel reflectModel1 = (ReflectModel) constructor1.newInstance(<span class="string">"else"</span>, <span class="number">10</span>);</span><br><span class="line">    reflectModel1.printName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参数构造函数</span></span><br><span class="line">    ReflectModel reflectModel2 = (ReflectModel) clFromName.newInstance();</span><br><span class="line">    reflectModel2.printName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用类的私有方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectMethod</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"com.yunlinos.reflectutils.ReflectModel"</span>);</span><br><span class="line">    Object object = clFromName.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参数私有方法</span></span><br><span class="line">    Method method0 = clFromName.getDeclaredMethod(<span class="string">"printOtherName"</span>);</span><br><span class="line">    method0.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    method0.invoke(object);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有参数私有方法</span></span><br><span class="line">    Method method1 = clFromName.getDeclaredMethod(<span class="string">"printOtherName"</span>, String.class);</span><br><span class="line">    method1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    method1.invoke(object, <span class="string">"yunlinos printOtherName"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用类的静态私有方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectStaticMethod</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"com.yunlinos.reflectutils.ReflectModel"</span>);</span><br><span class="line">    </span><br><span class="line">    Method method = clFromName.getDeclaredMethod(<span class="string">"workStatic"</span>);</span><br><span class="line">    method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    method.invoke(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取并修改类的私有字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectField</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"com.yunlinos.reflectutils.ReflectModel"</span>);</span><br><span class="line">    ReflectModel reflectModel = (ReflectModel) clFromName.newInstance();</span><br><span class="line"></span><br><span class="line">    Field field = clFromName.getDeclaredField(<span class="string">"name"</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object name = field.get(reflectModel);</span><br><span class="line">    System.out.println(name);</span><br><span class="line"></span><br><span class="line">    field.set(reflectModel, <span class="string">"yunlin reflect"</span>);</span><br><span class="line">    System.out.println(field.get(reflectModel));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取并修改类的静态私有字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectStaticField</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class clFromName = Class.forName(<span class="string">"com.yunlinos.reflectutils.ReflectModel"</span>);</span><br><span class="line"></span><br><span class="line">    Field field = clFromName.getDeclaredField(<span class="string">"tag"</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object tag = field.get(<span class="keyword">null</span>);</span><br><span class="line">    System.out.println(tag);</span><br><span class="line"></span><br><span class="line">    field.set(<span class="keyword">null</span>, <span class="string">"yunlin tag"</span>);</span><br><span class="line">    System.out.println(field.get(<span class="keyword">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="反射在Android中的实例"><a href="#反射在Android中的实例" class="headerlink" title="反射在Android中的实例"></a>反射在Android中的实例</h2><p>在Android中，如果我们自己创建代理对象，然后把原始对象替换为我们的代理对象，那么就可以在这个代理对象为所欲为了；比如修改参数，替换返回值等，这个技术我们通常也称之为Hook。</p>
<p>现在我们就是要hook掉系统的onClickListener对象，替换成我们自定义的代理对象，然后在代理对象中打印一条日志。</p>
<p>首先我们来看下系统点击事件的监听过程，即<code>setOnClickListener</code>后所发生的事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Register a callback to be invoked when this view is clicked. If this view is not</span></span><br><span class="line"><span class="comment"> * clickable, it becomes clickable.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> l The callback that will run</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setClickable(boolean)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnClickListener</span><span class="params">(OnClickListener l)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isClickable()) &#123;</span><br><span class="line">        setClickable(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getListenerInfo().mOnClickListener = l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在设置时间监听器后，将其赋值给了<code>mOnClickListener</code>这个变量，我们再来看下<code>getListenerInfo()</code>拿到了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ListenerInfo <span class="title">getListenerInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mListenerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mListenerInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    mListenerInfo = <span class="keyword">new</span> ListenerInfo();</span><br><span class="line">    <span class="keyword">return</span> mListenerInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实最终拿到的就是View中的一个ListenerInfo对象。这时候，我们就可以梳理下反射修改的过程了：</p>
<ol>
<li>反射<code>getListenerInfo()</code>方法，拿到<code>mListenerInfo</code>对象</li>
<li>将<code>mListenerInfo</code>中的<code>mOnClickListener</code>修改我们自定义的Listener</li>
<li>在自定义Listener中接管相关的点击事件</li>
</ol>
<p>下面，show the code：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TextView textView = findViewById(R.id.text_view);</span><br><span class="line">    textView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"onClick"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        hookClickListener(textView);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Hook fail!"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hookClickListener</span><span class="params">(View view)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 得到View的 ListenerInfo 对象</span></span><br><span class="line">        Method getListenerInfo = View.class.getDeclaredMethod(<span class="string">"getListenerInfo"</span>);</span><br><span class="line">        getListenerInfo.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object listenerInfo = getListenerInfo.invoke(view);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到原始的 OnClickListener 对象</span></span><br><span class="line">        Class&lt;?&gt; listenerInfoClz = Class.forName(<span class="string">"android.view.View$ListenerInfo"</span>);</span><br><span class="line">        Field onClickListener = listenerInfoClz.getDeclaredField(<span class="string">"mOnClickListener"</span>);</span><br><span class="line">        onClickListener.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        View.OnClickListener originOnClickListener = (View.OnClickListener) onClickListener.get(listenerInfo);</span><br><span class="line">        onClickListener.set(listenerInfo, <span class="keyword">new</span> HookOnClickListener(originOnClickListener));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HookOnClickListener</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> View.OnClickListener originOnClickListener;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HookOnClickListener</span><span class="params">(View.OnClickListener onClickListener)</span> </span>&#123;</span><br><span class="line">            originOnClickListener = onClickListener;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Hook success!"</span>);</span><br><span class="line">            originOnClickListener.onClick(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>反射可以算是Java中的神兵利器。不过，由于反射会额外消耗一定的系统资源，因此如果不需要动态地创建一个对象，那么就不需要用反射。而且反射调用方法时可以忽略权限检查，可能会因此导致安全问题。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    YunLinYe
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yunlinos.com/archives/92291dc1.html" title="Java 反射机制">http://yunlinos.com/archives/92291dc1.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/反射/" rel="tag"># 反射</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/archives/efd97a81.html" rel="next" title="类加载机制：Android ClassLoader">
                <i class="fa fa-chevron-left"></i> 类加载机制：Android ClassLoader
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/archives/875ee7f0.html" rel="prev" title="Java 动态代理机制">
                Java 动态代理机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/icon.png"
                alt="YunLinYe" />
            
              <p class="site-author-name" itemprop="name">YunLinYe</p>
              <p class="site-description motion-element" itemprop="description">生如逆旅，一苇以航</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yunlinos" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射的定义"><span class="nav-number">2.</span> <span class="nav-text">反射的定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射的原理"><span class="nav-number">3.</span> <span class="nav-text">反射的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射的用途"><span class="nav-number">4.</span> <span class="nav-text">反射的用途</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射的运用"><span class="nav-number">5.</span> <span class="nav-text">反射的运用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#得到类的对象"><span class="nav-number">5.1.</span> <span class="nav-text">得到类的对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取以及设置该类的字段、方法和属性"><span class="nav-number">5.2.</span> <span class="nav-text">获取以及设置该类的字段、方法和属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反射在Android中的实例"><span class="nav-number">6.</span> <span class="nav-text">反射在Android中的实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YunLinYe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io"  rel="external nofollow">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next"  rel="external nofollow">NexT.Mist</a> v5.1.4</div>


  <span class="post-meta-divider">|</span>

  <div class="powered-by">
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    本站访客数 <span id="busuanzi_value_site_uv"></span>
  </span>
  </div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>

<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="资源加载" />





  <link rel="alternate" href="/atom.xml" title="YunLinOS Notes" type="application/atom+xml" />






<meta name="description" content="前言在Android系统中，我们的应用程序会对设备的分辨率、大小、方向以及地区作相关的资源配置化，而在代码层面，我们通过资源ID即可拿到所需要的资源，而不必额外再去做相关的判断和兼容。也就是说，给定一个相同的资源ID，在不同的设备配置之下，拿到的的可能是不同的资源，而这个资源查找过程对应用程序来说，是完全透明的。 本文则是Android资源加载系列文章的上篇，主要是通过源码来了解资源加载的流程和原">
<meta name="keywords" content="资源加载">
<meta property="og:type" content="article">
<meta property="og:title" content="Android资源加载原理">
<meta property="og:url" content="http://yunlin.live/archives/81b378bd.html">
<meta property="og:site_name" content="YunLinOS Notes">
<meta property="og:description" content="前言在Android系统中，我们的应用程序会对设备的分辨率、大小、方向以及地区作相关的资源配置化，而在代码层面，我们通过资源ID即可拿到所需要的资源，而不必额外再去做相关的判断和兼容。也就是说，给定一个相同的资源ID，在不同的设备配置之下，拿到的的可能是不同的资源，而这个资源查找过程对应用程序来说，是完全透明的。 本文则是Android资源加载系列文章的上篇，主要是通过源码来了解资源加载的流程和原">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yunlin.live/archives/81b378bd/资源加载流程.png">
<meta property="og:image" content="http://yunlin.live/archives/81b378bd/初始化过程.png">
<meta property="og:updated_time" content="2018-10-16T13:11:18.099Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android资源加载原理">
<meta name="twitter:description" content="前言在Android系统中，我们的应用程序会对设备的分辨率、大小、方向以及地区作相关的资源配置化，而在代码层面，我们通过资源ID即可拿到所需要的资源，而不必额外再去做相关的判断和兼容。也就是说，给定一个相同的资源ID，在不同的设备配置之下，拿到的的可能是不同的资源，而这个资源查找过程对应用程序来说，是完全透明的。 本文则是Android资源加载系列文章的上篇，主要是通过源码来了解资源加载的流程和原">
<meta name="twitter:image" content="http://yunlin.live/archives/81b378bd/资源加载流程.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yunlin.live/archives/81b378bd.html"/>





  <title>Android资源加载原理 | YunLinOS Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YunLinOS Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yunlin.live/archives/81b378bd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YunLinOS">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/icon.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YunLinOS Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android资源加载原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-16T21:04:07+08:00">
                2018-10-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android插件化和热修复/" itemprop="url" rel="index">
                    <span itemprop="name">Android插件化和热修复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Android系统中，我们的应用程序会对设备的分辨率、大小、方向以及地区作相关的资源配置化，而在代码层面，我们通过资源ID即可拿到所需要的资源，而不必额外再去做相关的判断和兼容。也就是说，给定一个相同的资源ID，在不同的设备配置之下，拿到的的可能是不同的资源，而这个资源查找过程对应用程序来说，是完全透明的。</p>
<p>本文则是Android资源加载系列文章的上篇，主要是通过源码来了解资源加载的流程和原理，为后面资源插件化的工作做准备。我们将会带着以下几个疑问来开始源码之路：</p>
<ol>
<li>如何根据资源ID来拿到对应的资源？</li>
<li>如何拿到系统的资源，即位于framework-res中的资源？</li>
<li>如何根据设备的分辨率、语言等信息来加载资源？</li>
</ol>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>源码位置，为Android 6.0：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/</span><br><span class="line">    	- ContextImpl.java</span><br><span class="line">    	- ResourcesManager.java</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/content/res/</span><br><span class="line">    	- Resources.java</span><br><span class="line">    	- ResourcesImpl.java</span><br><span class="line">		- AssetManager.java</span><br><span class="line"></span><br><span class="line">frameworks/base/core/jni/</span><br><span class="line">    	- android_util_AssetManager.cpp</span><br><span class="line"></span><br><span class="line">frameworks/base/libs/androidfw/</span><br><span class="line">    	- AssetManager.cpp</span><br></pre></td></tr></table></figure>
<p>资源加载流程图：</p>
<p><img src="/archives/81b378bd/资源加载流程.png" alt="资源加载流程"></p>
<p>对于Android程序，其应用资源主要分为两类，分别为assets和res。</p>
<ol>
<li><strong>assets：</strong>放在根目录的assets文件夹中，主要是以原始文件的形式打包在apk中，通过文件名即可直接访问</li>
<li><strong>res：</strong>放在根目录的res文件夹中，会被编译打包进apk中，并会被赋予资源ID，通过该ID即可直接访问</li>
</ol>
<p>即对于以下两种方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AssetManager通过文件名来获取资源</span></span><br><span class="line">getAssets().open(<span class="string">"file_name"</span>);</span><br><span class="line"><span class="comment">// Resources通过ID来获取资源</span></span><br><span class="line">getResources().getString(R.string.app_name);</span><br></pre></td></tr></table></figure>
<p>另外，由于根据资源ID来查到对应资源的路径更完整，下面将会以这个为突破点进行研究。</p>
<h2 id="资源加载流程"><a href="#资源加载流程" class="headerlink" title="资源加载流程"></a>资源加载流程</h2><p>首先我们来看获取资源的标准方法：</p>
<blockquote>
<p>getResources().getString(R.string.app_name);</p>
</blockquote>
<p>从上面一篇博文中可以知道，Activity组件是继承自Context的，而其接口的大多数实现实际上是转发给ContextImpl来进行处理的，其中就包括getResource方法：</p>
<p>[-&gt; ContextImpl.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getResources().getAssets();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mResources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而mResources对象则是在上下文环境初始化时进行创建的，即：</p>
<p>[-&gt; ContextImpl.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ContextImpl.createResources</span></span><br><span class="line"><span class="comment">    * 该方法在以下方法创建 Context 实例时均会调用</span></span><br><span class="line"><span class="comment">    * ContextImpl.createApplicationContext()</span></span><br><span class="line"><span class="comment">    * ContextImpl.createPackageContextAsUser()</span></span><br><span class="line"><span class="comment">    * ContextImpl.createConfigurationContext()</span></span><br><span class="line"><span class="comment">    * ContextImpl.createSystemUiContext()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Resources <span class="title">createResources</span><span class="params">(IBinder activityToken, LoadedApk pi, String splitName,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> displayId, Configuration overrideConfig, CompatibilityInfo compatInfo)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> String[] splitResDirs;</span><br><span class="line">       <span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           splitResDirs = pi.getSplitPaths(splitName);</span><br><span class="line">           classLoader = pi.getSplitClassLoader(splitName);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> ResourcesManager.getInstance().getResources(activityToken,</span><br><span class="line">               pi.getResDir(),</span><br><span class="line">               splitResDirs,</span><br><span class="line">               pi.getOverlayDirs(),</span><br><span class="line">               pi.getApplicationInfo().sharedLibraryFiles,</span><br><span class="line">               displayId,</span><br><span class="line">               overrideConfig,</span><br><span class="line">               compatInfo,</span><br><span class="line">               classLoader);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>接下来，继续分析ResourcesManager类中的getResources方法：</p>
<p>[-&gt; ResourcesManager.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets or creates a new Resources object associated with the IBinder token. References returned</span></span><br><span class="line"><span class="comment"> * by this method live as long as the Activity, meaning they can be cached and used by the</span></span><br><span class="line"><span class="comment"> * Activity even after a configuration change. If any other parameter is changed</span></span><br><span class="line"><span class="comment"> * (resDir, splitResDirs, overrideConfig) for a given Activity, the same Resources object</span></span><br><span class="line"><span class="comment"> * is updated and handed back to the caller. However, changing the class loader will result in a</span></span><br><span class="line"><span class="comment"> * new Resources object.</span></span><br><span class="line"><span class="comment"> * &lt;p/&gt;</span></span><br><span class="line"><span class="comment"> * If activityToken is null, a cached Resources object will be returned if it matches the</span></span><br><span class="line"><span class="comment"> * input parameters. Otherwise a new Resources object that satisfies these parameters is</span></span><br><span class="line"><span class="comment"> * returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activityToken Represents an Activity. If null, global resources are assumed.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resDir The base resource path. Can be null (only framework resources will be loaded).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> splitResDirs An array of split resource paths. Can be null.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> overlayDirs An array of overlay paths. Can be null.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> libDirs An array of resource library paths. Can be null.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> displayId The ID of the display for which to create the resources.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> overrideConfig The configuration to apply on top of the base configuration. Can be</span></span><br><span class="line"><span class="comment"> * null. Mostly used with Activities that are in multi-window which may override width and</span></span><br><span class="line"><span class="comment"> * height properties from the base config.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> compatInfo The compatibility settings to use. Cannot be null. A default to use is</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> CompatibilityInfo#DEFAULT_COMPATIBILITY_INFO&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader The class loader to use when inflating Resources. If null, the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ClassLoader#getSystemClassLoader()&#125; is used.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a Resources object from which to access resources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String resDir,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] splitResDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] overlayDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] libDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, <span class="string">"ResourcesManager#getResources"</span>);</span><br><span class="line">        <span class="comment">// 构造Resource的key, 通过key可以从缓存中查找Resource对象</span></span><br><span class="line">        <span class="keyword">final</span> ResourcesKey key = <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                resDir,</span><br><span class="line">                splitResDirs,</span><br><span class="line">                overlayDirs,</span><br><span class="line">                libDirs,</span><br><span class="line">                displayId,</span><br><span class="line">                overrideConfig != <span class="keyword">null</span> ? <span class="keyword">new</span> Configuration(overrideConfig) : <span class="keyword">null</span>, <span class="comment">// Copy</span></span><br><span class="line">                compatInfo);</span><br><span class="line">        classLoader = classLoader != <span class="keyword">null</span> ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="comment">// 调用 getOrCreateResources 方法去获取 Resource 实例</span></span><br><span class="line">        <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实该方法的注释已经将其作用解释得较为清晰了，我们尝试解释下：通过该方法，将会通过IBinder对象（activityToken）获取或者创建新的Resource对象，并且该方法返回的引用与Activity生命周期一样长，这也就意味着即使在配置更改之后，它们也可以被活动缓存和使用。如果对给定的Activity更改了任何其他参数 (resDir、splitResDirs、overrideConfig、classLoader)，将会重新创建Resources对象并将其返回给调用者。</p>
<p>下面，我们进入getOrCreateResources方法中来看具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets an existing Resources object set with a ResourcesImpl object matching the given key,</span></span><br><span class="line"><span class="comment"> * or creates one if it doesn't exist.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activityToken The Activity this Resources object should be associated with.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key describing the parameters of the ResourcesImpl object.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader The classloader to use for the Resources object.</span></span><br><span class="line"><span class="comment"> *                    If null, &#123;<span class="doctag">@link</span> ClassLoader#getSystemClassLoader()&#125; is used.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A Resources object that gets updated when</span></span><br><span class="line"><span class="comment"> *         &#123;<span class="doctag">@link</span> #applyConfigurationToResourcesLocked(Configuration, CompatibilityInfo)&#125;</span></span><br><span class="line"><span class="comment"> *         is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getOrCreateResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull ResourcesKey key, @NonNull ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Throwable here = <span class="keyword">new</span> Throwable();</span><br><span class="line">            here.fillInStackTrace();</span><br><span class="line">            Slog.w(TAG, <span class="string">"!! Get resources for activity="</span> + activityToken + <span class="string">" key="</span> + key, here);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityResources activityResources =</span><br><span class="line">                    getOrCreateActivityResourcesStructLocked(activityToken);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Clean up any dead references so they don't pile up.</span></span><br><span class="line">            ArrayUtils.unstableRemoveIf(activityResources.activityResources,</span><br><span class="line">                    sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Rebase the key's override config on top of the Activity's base override.</span></span><br><span class="line">            <span class="keyword">if</span> (key.hasOverrideConfiguration()</span><br><span class="line">                    &amp;&amp; !activityResources.overrideConfig.equals(Configuration.EMPTY)) &#123;</span><br><span class="line">                <span class="keyword">final</span> Configuration temp = <span class="keyword">new</span> Configuration(activityResources.overrideConfig);</span><br><span class="line">                temp.updateFrom(key.mOverrideConfiguration);</span><br><span class="line">                key.mOverrideConfiguration.setTo(temp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过 findResourcesImplForKeyLocked() 方法获取 resourcesImpl，该方法主要是看缓存中是否有最新的已存在的ResourcesImpl</span></span><br><span class="line">            ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">            <span class="keyword">if</span> (resourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"- using existing impl="</span> + resourcesImpl);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> getOrCreateResourcesForActivityLocked(activityToken, classLoader,</span><br><span class="line">                        resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We will create the ResourcesImpl object outside of holding this lock.</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Clean up any dead references so they don't pile up.</span></span><br><span class="line">            ArrayUtils.unstableRemoveIf(mResourceReferences, sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Not tied to an Activity, find a shared Resources that has the right ResourcesImpl</span></span><br><span class="line">            ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">            <span class="keyword">if</span> (resourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"- using existing impl="</span> + resourcesImpl);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We will create the ResourcesImpl object outside of holding this lock.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're here, we didn't find a suitable ResourcesImpl to use, so create one now.</span></span><br><span class="line">    <span class="comment">// 通过 createResourcesImpl 创建 ResourcesImpl 对象</span></span><br><span class="line">    ResourcesImpl resourcesImpl = createResourcesImpl(key);</span><br><span class="line">    <span class="keyword">if</span> (resourcesImpl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 用于二次检验, 防止往 mResourceImpls Map 中 put 多次, 类似于双重锁机制</span></span><br><span class="line">        ResourcesImpl existingResourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">        <span class="keyword">if</span> (existingResourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"- got beat! existing impl="</span> + existingResourcesImpl</span><br><span class="line">                        + <span class="string">" new impl="</span> + resourcesImpl);</span><br><span class="line">            &#125;</span><br><span class="line">            resourcesImpl.getAssets().close();</span><br><span class="line">            resourcesImpl = existingResourcesImpl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Add this ResourcesImpl to the cache.</span></span><br><span class="line">            <span class="comment">// 将创建好的 resourcesImpl 实例加入缓存中</span></span><br><span class="line">            mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(resourcesImpl));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources resources;</span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resources = getOrCreateResourcesForActivityLocked(activityToken, classLoader,</span><br><span class="line">                    resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resources;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds a cached ResourcesImpl object that matches the given ResourcesKey.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key to match.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a ResourcesImpl if the key matches a cache entry, null otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">findResourcesImplForKeyLocked</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.get(key);</span><br><span class="line">    ResourcesImpl impl = weakImplRef != <span class="keyword">null</span> ? weakImplRef.get() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (impl != <span class="keyword">null</span> &amp;&amp; impl.getAssets().isUpToDate()) &#123;</span><br><span class="line">        <span class="keyword">return</span> impl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是通过ResourcesKey从缓存mResourceImpls中拿到ResourcesImpl，如果拿到的ResourcesImpl不为空且是最新的，即调用这个Resources对象的成员函数getAssets所获得一个AssetManager对象的成员函数isUpToDate的返回值等于true，则直接通过getOrCreateResourcesForActivityLocked返回；</p>
<p>如果拿到的ResourcesImpl为空，或者该ResourcesImpl对象是过时的，则通过createResourcesImpl创建ResourcesImpl对象，并会再次通过findResourcesImplForKeyLocked拿到是否有缓存的对象（在加锁中的该操作是避免重复创建，需要再次检查该HashMap是否已经存在一个对应的Resources对象了，这是因为当前线程在创建新的AssetManager对象和Resources对象的过程中，可能有其它线程抢先一步创建了与参数resDir对应的Resources对象，并且将该Resources对象保存到该HashMap中去了），如果没有，则会直接放入到缓存中，再通过getOrCreateResourcesLocked拿到Resources对象。</p>
<p>首先，我们来分析getOrCreateResourcesForActivityLocked：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> * Finds a cached ResourcesImpl object that matches the given ResourcesKey.</span><br><span class="line"> *</span><br><span class="line"> * <span class="meta">@param</span> key The key to match.</span><br><span class="line"> * <span class="meta">@return</span> a ResourcesImpl <span class="keyword">if</span> the key matches a cache entry, <span class="keyword">null</span> otherwise.</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">findResourcesImplForKeyLocked</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.get(key);</span><br><span class="line">    ResourcesImpl impl = weakImplRef != <span class="keyword">null</span> ? weakImplRef.get() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (impl != <span class="keyword">null</span> &amp;&amp; impl.getAssets().isUpToDate()) &#123;</span><br><span class="line">        <span class="keyword">return</span> impl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds a cached ResourcesImpl object that matches the given ResourcesKey, or</span></span><br><span class="line"><span class="comment"> * creates a new one and caches it for future use.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key to match.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a ResourcesImpl object matching the key.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">findOrCreateResourcesImplForKeyLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    ResourcesImpl impl = findResourcesImplForKeyLocked(key);</span><br><span class="line">    <span class="comment">// 从缓存中查找ResourcesImpl对象，如果拿到的对象为空，则通过createResourcesImpl来创建ResourcesImpl对象，并放入到缓存中</span></span><br><span class="line">    <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        impl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(impl));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">    daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首先创建AssetManager对象，然后创建ResourcesImpl对象，并将显示配置进行绑定</span></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">    <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">    <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"- creating impl="</span> + impl + <span class="string">" with key: "</span> + key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再来分析getOrCreateResourcesLocked方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets an existing Resources object if the class loader and ResourcesImpl are the same,</span></span><br><span class="line"><span class="comment"> * otherwise creates a new Resources object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">Resources <span class="title">getOrCreateResourcesLocked</span><span class="params">(@NonNull ClassLoader classLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull ResourcesImpl impl, @NonNull CompatibilityInfo compatInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Find an existing Resources that has this ResourcesImpl set.</span></span><br><span class="line">    <span class="comment">// 遍历 mResourceReferences 集合, 在缓存中找到当前传入 classLoader/impl 对应的 resource</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> refCount = mResourceReferences.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; refCount; i++) &#123;</span><br><span class="line">        WeakReference&lt;Resources&gt; weakResourceRef = mResourceReferences.get(i);</span><br><span class="line">        Resources resources = weakResourceRef.get();</span><br><span class="line">        <span class="keyword">if</span> (resources != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                Objects.equals(resources.getClassLoader(), classLoader) &amp;&amp;</span><br><span class="line">                resources.getImpl() == impl) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"- using existing ref="</span> + resources);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> resources;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a new Resources reference and use the existing ResourcesImpl object.</span></span><br><span class="line">    <span class="comment">// 若缓存中没有, 则创建新的对象</span></span><br><span class="line">    Resources resources = compatInfo.needsCompatResources() ? <span class="keyword">new</span> CompatResources(classLoader)</span><br><span class="line">            : <span class="keyword">new</span> Resources(classLoader);</span><br><span class="line">    <span class="comment">// 将 resource 与 impl 绑定</span></span><br><span class="line">    resources.setImpl(impl);</span><br><span class="line">    <span class="comment">// 添加到缓存集合中</span></span><br><span class="line">    mResourceReferences.add(<span class="keyword">new</span> WeakReference&lt;&gt;(resources));</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"- creating new ref="</span> + resources);</span><br><span class="line">        Slog.d(TAG, <span class="string">"- setting ref="</span> + resources + <span class="string">" with impl="</span> + impl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，我们就看到Resource的创建，并且绑定了ResourcesImpl。不过，在创建ResourcesImpl时，还有一个函数我们没有分析，也就是创建AssetManager对象，而该对象则是我们获取资源的最佳猎手，我们现在来看下具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an AssetManager from the paths within the ResourcesKey.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This can be overridden in tests so as to avoid creating a real AssetManager with</span></span><br><span class="line"><span class="comment"> * real APK paths.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key containing the resource paths to add to the AssetManager.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a new AssetManager.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">protected</span> <span class="meta">@Nullable</span> <span class="function">AssetManager <span class="title">createAssetManager</span><span class="params">(@NonNull <span class="keyword">final</span> ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过构造函数创建AssetManager对象</span></span><br><span class="line">    AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resDir can be null if the 'android' package is creating a new Resources object.</span></span><br><span class="line">    <span class="comment">// This is fine, since each AssetManager automatically loads the 'android' package</span></span><br><span class="line">    <span class="comment">// already.</span></span><br><span class="line">    <span class="keyword">if</span> (key.mResDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将当前 App 的资源(resource.arsc)加载到 AssetManager 中</span></span><br><span class="line">        <span class="keyword">if</span> (assets.addAssetPath(key.mResDir) == <span class="number">0</span>) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"failed to add asset path "</span> + key.mResDir);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mSplitResDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String splitResDir : key.mSplitResDirs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (assets.addAssetPath(splitResDir) == <span class="number">0</span>) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"failed to add split asset path "</span> + splitResDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mOverlayDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String idmapPath : key.mOverlayDirs) &#123;</span><br><span class="line">            assets.addOverlayPath(idmapPath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mLibDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String libDir : key.mLibDirs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (libDir.endsWith(<span class="string">".apk"</span>)) &#123;</span><br><span class="line">                <span class="comment">// Avoid opening files we know do not have resources,</span></span><br><span class="line">                <span class="comment">// like code-only .jar files.</span></span><br><span class="line">                <span class="keyword">if</span> (assets.addAssetPathAsSharedLibrary(libDir) == <span class="number">0</span>) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Asset path '"</span> + libDir +</span><br><span class="line">                            <span class="string">"' does not exist or contains no resources."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> assets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们来到AssetManager中，来看下初始化做了些什么工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new AssetManager containing only the basic system assets.</span></span><br><span class="line"><span class="comment"> * Applications will not generally use this method, instead retrieving the</span></span><br><span class="line"><span class="comment"> * appropriate asset manager with &#123;<span class="doctag">@link</span> Resources#getAssets&#125;.    Not for</span></span><br><span class="line"><span class="comment"> * use by applications.</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AssetManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REFS) &#123;</span><br><span class="line">            mNumRefs = <span class="number">0</span>;</span><br><span class="line">            incRefsLocked(<span class="keyword">this</span>.hashCode());</span><br><span class="line">        &#125;</span><br><span class="line">        init(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"New asset manager: "</span> + <span class="keyword">this</span>);</span><br><span class="line">        ensureSystemAssets();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ensureSystemAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sSystem == <span class="keyword">null</span>) &#123;</span><br><span class="line">            AssetManager system = <span class="keyword">new</span> AssetManager(<span class="keyword">true</span>);</span><br><span class="line">            system.makeStringBlocks(<span class="keyword">null</span>);</span><br><span class="line">            sSystem = system;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AssetManager</span><span class="params">(<span class="keyword">boolean</span> isSystem)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REFS) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mNumRefs = <span class="number">0</span>;</span><br><span class="line">            incRefsLocked(<span class="keyword">this</span>.hashCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    init(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"New asset manager: "</span> + <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">boolean</span> isSystem)</span></span>;</span><br></pre></td></tr></table></figure>
<p>AssetManager类的构造函数是通过调用init函数来执行初始化工作的。在初始化完成当前正在创建的AssetManager对象之后，AssetManager类的构造函数还会调用另外一个成员函数ensureSystemAssets来检查当前进程是否已经创建了一个用来访问系统资源的AssetManager对象。</p>
<p>如果用来访问系统资源的AssetManager对象还没有创建的话，那么AssetManager类的成员函数ensureSystemAssets就会创建并且初始化它，并且将它保存在AssetManager类的静态成员变量sSystem中。另外，创建用来访问系统资源和应用程序资源的AssetManager对象的过程是一样的，区别只在于它们所要访问的文件不一样，因此，接下来我们就只分析用来访问应用资源的AssetManager对象的创建过程以及初始化过程。为啥会有两个AssetManager对象呢？这就要回到我们最开始提到的第二个问题：如何拿到系统的资源，即位于framework-res中的资源？</p>
<p>系统的资源打包在/system/framework/framework-res.apk文件中，它在应用程序进程中是通过一个单独的Resources对象和一个单独的AssetManager对象来管理的。这个单独的Resources对象就保存在Resources类的静态成员变量mSystem中，我们可以通过Resources类的静态成员函数getSystem就可以获得这个Resources对象，而这个单独的AssetManager对象就保存在AssetManager类的静态成员变量sSystem中，我们可以通过AssetManager类的静态成员函数getSystem同样可以获得这个AssetManager对象。</p>
<p>现在，我们进入到AssetManager的C++代码中，简单看了具体实现：</p>
<p>[-&gt; android_util_AssetManager.cpp]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_content_AssetManager_init</span><span class="params">(JNIEnv* env, jobject clazz, jboolean isSystem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isSystem) &#123;</span><br><span class="line">        verifySystemIdmaps();</span><br><span class="line">    &#125;</span><br><span class="line">    AssetManager* am = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="keyword">if</span> (am == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">"java/lang/OutOfMemoryError"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    am-&gt;addDefaultAssets();</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"Created AssetManager %p for Java object %p\n"</span>, am, clazz);</span><br><span class="line">    env-&gt;SetLongField(clazz, gAssetManagerOffsets.mObject, <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(am));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先创建一个C++层的AssetManager对象，接着调用这个C++层的AssetManager对象的成员函数addDefaultAssets来添加默认的资源路径，最后将这个这个C++层的AssetManager对象的地址保存在参数clazz所描述的一个Java层的AssetManager对象的成员变量mObject中。</p>
<p>再来看下addDefaultAssets中具体内容：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> AssetManager::addDefaultAssets()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取 Android 系统资源路径</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* root = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(root == <span class="literal">NULL</span>, <span class="string">"ANDROID_ROOT not set"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化的时候会去加载系统的 framework-res.apk 资源</span></span><br><span class="line">    <span class="function">String8 <span class="title">path</span><span class="params">(root)</span></span>;</span><br><span class="line">    <span class="comment">// 也就是说我们为什么能加载系统的资源如颜色、图片、文字等等</span></span><br><span class="line">    path.appendPath(kSystemAssets);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过系统资源路径去添加系统资源</span></span><br><span class="line">    <span class="keyword">return</span> addAssetPath(path, <span class="literal">NULL</span>, <span class="literal">false</span> <span class="comment">/* appAsLib */</span>, <span class="literal">true</span> <span class="comment">/* isSystemAsset */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过资源路径去添加资源</span></span><br><span class="line"><span class="keyword">bool</span> AssetManager::addAssetPath(</span><br><span class="line">        <span class="keyword">const</span> String8&amp; path, <span class="keyword">int32_t</span>* cookie, <span class="keyword">bool</span> appAsLib, <span class="keyword">bool</span> isSystemAsset) &#123;</span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">    asset_path ap;</span><br><span class="line"></span><br><span class="line">    <span class="function">String8 <span class="title">realPath</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (kAppZipName) &#123;</span><br><span class="line">        realPath.appendPath(kAppZipName);</span><br><span class="line">    &#125;</span><br><span class="line">    ap.type = ::getFileType(realPath.<span class="built_in">string</span>());</span><br><span class="line">    <span class="keyword">if</span> (ap.type == kFileTypeRegular) &#123;</span><br><span class="line">        ap.path = realPath;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ap.path = path;</span><br><span class="line">        ap.type = ::getFileType(path.<span class="built_in">string</span>());</span><br><span class="line">        <span class="keyword">if</span> (ap.type != kFileTypeDirectory &amp;&amp; ap.type != kFileTypeRegular) &#123;</span><br><span class="line">            ALOGW(<span class="string">"Asset path %s is neither a directory nor file (type=%d)."</span>,</span><br><span class="line">                 path.<span class="built_in">string</span>(), (<span class="keyword">int</span>)ap.type);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip if we have it already.</span></span><br><span class="line">    <span class="comment">// 遍历 native 中维护的资源路径数组 mAssetPaths, 判断传入的 path 是否已经存在，如果存在直接返回</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;mAssetPaths.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAssetPaths[i].path == ap.path) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cookie) &#123;</span><br><span class="line">                *cookie = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(i+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"In %p Asset %s path: %s"</span>, <span class="keyword">this</span>,</span><br><span class="line">         ap.type == kFileTypeDirectory ? <span class="string">"dir"</span> : <span class="string">"zip"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    ap.isSystemAsset = isSystemAsset;</span><br><span class="line">    <span class="comment">// 若是新文件路径, 且通过了相关校验, 则添加到这个资源路径数组 mAssetPaths 中</span></span><br><span class="line">    mAssetPaths.add(ap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new paths are always added at the end</span></span><br><span class="line">    <span class="comment">// 新路径总是补充到最后</span></span><br><span class="line">    <span class="keyword">if</span> (cookie) &#123;</span><br><span class="line">        *cookie = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(mAssetPaths.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID__</span></span><br><span class="line">    <span class="comment">// Load overlays, if any</span></span><br><span class="line">    asset_path oap;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> idx = <span class="number">0</span>; mZipSet.getOverlay(ap.path, idx, &amp;oap); idx++) &#123;</span><br><span class="line">        oap.isSystemAsset = isSystemAsset;</span><br><span class="line">        mAssetPaths.add(oap);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加到Resource资源表中</span></span><br><span class="line">    <span class="keyword">if</span> (mResources != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        appendPathToResTable(ap, appAsLib);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看appendPathToResTable的具体实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> AssetManager::appendPathToResTable(<span class="keyword">const</span> asset_path&amp; ap, <span class="keyword">bool</span> appAsLib) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="comment">// skip those ap's that correspond to system overlays</span></span><br><span class="line">    <span class="comment">// 判断是否为系统资源覆盖，如果是的则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (ap.isSystemOverlay) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Asset* ass = <span class="literal">NULL</span>;</span><br><span class="line">    ResTable* sharedRes = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">bool</span> shared = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">bool</span> onlyEmptyResources = <span class="literal">true</span>;</span><br><span class="line">    ATRACE_NAME(ap.path.<span class="built_in">string</span>());</span><br><span class="line">    <span class="comment">// 资源覆盖机制</span></span><br><span class="line">    Asset* idmap = openIdmapLocked(ap);</span><br><span class="line">    <span class="comment">// 当前资源表的数量</span></span><br><span class="line">    <span class="keyword">size_t</span> nextEntryIdx = mResources-&gt;getTableCount();</span><br><span class="line">    ALOGV(<span class="string">"Looking for resource asset in '%s'\n"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">    <span class="comment">// 资源路径是一个非文件夹路径，也就是apk路径</span></span><br><span class="line">    <span class="keyword">if</span> (ap.type != kFileTypeDirectory) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextEntryIdx == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// The first item is typically the framework resources,</span></span><br><span class="line">            <span class="comment">// which we want to avoid parsing every time.</span></span><br><span class="line">            sharedRes = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">                mZipSet.getZipResourceTable(ap.path);</span><br><span class="line">            <span class="comment">// 肯定不为NULL, 因为framework-res.apk一定存在 "resources.arsc" 文件</span></span><br><span class="line">            <span class="keyword">if</span> (sharedRes != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// skip ahead the number of system overlay packages preloaded</span></span><br><span class="line">                nextEntryIdx = sharedRes-&gt;getTableCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sharedRes == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ass = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">                mZipSet.getZipResourceTableAsset(ap.path);</span><br><span class="line">            <span class="keyword">if</span> (ass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ALOGV(<span class="string">"loading resource table %s\n"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">                ass = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">                    openNonAssetInPathLocked(<span class="string">"resources.arsc"</span>,</span><br><span class="line">                                             Asset::ACCESS_BUFFER,</span><br><span class="line">                                             ap);</span><br><span class="line">                <span class="keyword">if</span> (ass != <span class="literal">NULL</span> &amp;&amp; ass != kExcludedAsset) &#123;</span><br><span class="line">                    ass = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">                        mZipSet.setZipResourceTableAsset(ap.path, ass);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (nextEntryIdx == <span class="number">0</span> &amp;&amp; ass != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// If this is the first resource table in the asset</span></span><br><span class="line">                <span class="comment">// manager, then we are going to cache it so that we</span></span><br><span class="line">                <span class="comment">// can quickly copy it out for others.</span></span><br><span class="line">                ALOGV(<span class="string">"Creating shared resources for %s"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">                sharedRes = <span class="keyword">new</span> ResTable();</span><br><span class="line">                sharedRes-&gt;add(ass, idmap, nextEntryIdx + <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID__</span></span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">char</span>* data = getenv(<span class="string">"ANDROID_DATA"</span>);</span><br><span class="line">                LOG_ALWAYS_FATAL_IF(data == <span class="literal">NULL</span>, <span class="string">"ANDROID_DATA not set"</span>);</span><br><span class="line">                <span class="function">String8 <span class="title">overlaysListPath</span><span class="params">(data)</span></span>;</span><br><span class="line">                overlaysListPath.appendPath(kResourceCache);</span><br><span class="line">                overlaysListPath.appendPath(<span class="string">"overlays.list"</span>);</span><br><span class="line">                addSystemOverlays(overlaysListPath.<span class="built_in">string</span>(), ap.path, sharedRes, nextEntryIdx);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                sharedRes = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">                    mZipSet.setZipResourceTable(ap.path, sharedRes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGV(<span class="string">"loading resource table %s\n"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// 查找 "resources.arsc", 从中获取 Asset 资源</span></span><br><span class="line">        ass = <span class="keyword">const_cast</span>&lt;AssetManager*&gt;(<span class="keyword">this</span>)-&gt;</span><br><span class="line">            openNonAssetInPathLocked(<span class="string">"resources.arsc"</span>,</span><br><span class="line">                                     Asset::ACCESS_BUFFER,</span><br><span class="line">                                     ap);</span><br><span class="line">        shared = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将解析到的资源添加到 mResources 中维护</span></span><br><span class="line">    <span class="keyword">if</span> ((ass != <span class="literal">NULL</span> || sharedRes != <span class="literal">NULL</span>) &amp;&amp; ass != kExcludedAsset) &#123;</span><br><span class="line">        ALOGV(<span class="string">"Installing resource asset %p in to table %p\n"</span>, ass, mResources);</span><br><span class="line">        <span class="comment">// Android framework-res.apk 资源包时</span></span><br><span class="line">        <span class="keyword">if</span> (sharedRes != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGV(<span class="string">"Copying existing resources for %s"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">            mResources-&gt;add(sharedRes, ap.isSystemAsset);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非Android framework-res.apk 资源包时</span></span><br><span class="line">            ALOGV(<span class="string">"Parsing resources for %s"</span>, ap.path.<span class="built_in">string</span>());</span><br><span class="line">            mResources-&gt;add(ass, idmap, nextEntryIdx + <span class="number">1</span>, !shared, appAsLib, ap.isSystemAsset);</span><br><span class="line">        &#125;</span><br><span class="line">        onlyEmptyResources = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!shared) &#123;</span><br><span class="line">            <span class="keyword">delete</span> ass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGV(<span class="string">"Installing empty resources in to table %p\n"</span>, mResources);</span><br><span class="line">        mResources-&gt;addEmpty(nextEntryIdx + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idmap != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> idmap;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> onlyEmptyResources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若传入的路径对应的为一个apk，则优先加载 framework-res.apk 中的资源,，因为Framework 层的 AssetManager 创建的时候一定会先调用 init() 加载系统资源,，再调用 addAssetPath() 加载当前应用资源<br>加载当前应用资源。若传入的为一个文件, 则直接解析其中的 “resources.arsc” 文件，将解析到的所有资源添加到 mResources(ResTable) 中集中缓存。</p>
<p>至此，我们就得到了所有资源的集合，那么从最上层又是如何获取到该资源呢：</p>
<p>[-&gt; Resources.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(@StringRes <span class="keyword">int</span> id)</span> <span class="keyword">throws</span> NotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getText(id).toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span> <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getText</span><span class="params">(@StringRes <span class="keyword">int</span> id)</span> <span class="keyword">throws</span> NotFoundException </span>&#123;</span><br><span class="line">    CharSequence res = mResourcesImpl.getAssets().getResourceText(id);</span><br><span class="line">    <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundException(<span class="string">"String resource ID #0x"</span></span><br><span class="line">            + Integer.toHexString(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt; ResourcesImpl.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mAssets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[-&gt; AssetManager.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> CharSequence <span class="title">getResourceText</span><span class="params">(@StringRes <span class="keyword">int</span> resId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> TypedValue outValue = mValue;</span><br><span class="line">        <span class="keyword">if</span> (getResourceValue(resId, <span class="number">0</span>, outValue, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> outValue.coerceToString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getResourceValue</span><span class="params">(@AnyRes <span class="keyword">int</span> resId, <span class="keyword">int</span> densityDpi, @NonNull TypedValue outValue,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> resolveRefs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> block = loadResourceValue(resId, (<span class="keyword">short</span>) densityDpi, outValue, resolveRefs);</span><br><span class="line">        <span class="keyword">if</span> (block &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert the changing configurations flags populated by native code.</span></span><br><span class="line">        outValue.changingConfigurations = ActivityInfo.activityInfoConfigNativeToJava(</span><br><span class="line">                outValue.changingConfigurations);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outValue.type == TypedValue.TYPE_STRING) &#123;</span><br><span class="line">            outValue.string = mStringBlocks[block].get(outValue.data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">loadResourceValue</span><span class="params">(<span class="keyword">int</span> ident, <span class="keyword">short</span> density, TypedValue outValue,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> resolve)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其初始化流程图为：</p>
<p><img src="/archives/81b378bd/初始化过程.png" alt="初始化过程"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/luoshengyang/article/details/8738877" target="_blank" rel="noopener">Android资源管理框架（Asset Manager）简要介绍和学习计划</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    YunLinOS
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yunlinos.com/archives/81b378bd.html" title="Android资源加载原理">http://yunlinos.com/archives/81b378bd.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/archives/41260128.html" rel="next" title="Why use ContextImpl to implement Context rather than ContextWrapper in Android?">
                <i class="fa fa-chevron-left"></i> Why use ContextImpl to implement Context rather than ContextWrapper in Android?
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/icon.png"
                alt="YunLinOS" />
            
              <p class="site-author-name" itemprop="name">YunLinOS</p>
              <p class="site-description motion-element" itemprop="description">生如逆旅，一苇以航</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yunlinos" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">2.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资源加载流程"><span class="nav-number">3.</span> <span class="nav-text">资源加载流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YunLinOS</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io"  rel="external nofollow">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next"  rel="external nofollow">NexT.Mist</a> v5.1.4</div>


  <span class="post-meta-divider">|</span>

  <div class="powered-by">
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
    本站访客数 <span id="busuanzi_value_site_uv"></span>
  </span>
  </div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
